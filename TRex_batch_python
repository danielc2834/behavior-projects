import subprocess
import pandas as pd
import os, sys
#if subfolders are used, put path to folder containing them, in inputpath2
inputpath2 = r"D:/Videos/395_IR8a_[1];IR25a_[2];Orco_[1],Gr63a_[1]_(anosmic)"
outputpath = r"D:/TRex_data"
trex = r"C:\Users\cdaniel\.conda\envs\batchtgrabs\bin\trex.exe"
tgrabs = r"C:\Users\cdaniel\.conda\envs\batchtgrabs\bin\tgrabs.exe"
dirs2 = os.listdir(inputpath2)
#path to the excel sheet with name and individual number 
df = pd.read_csv("D:\TRex_data\Behaviour_log.csv")
#read out collumn of filename and number of individuals tracked
inputcsv = df.iloc[:,7:9]
liste = inputcsv.values.tolist()
#if no subfolders are used and videos are inside inputpath2 folder, comment this out and change inputpath2 (line4) into inputpath and dirs2 indto dirs (line8)
for j in dirs2: 
    inputpath = f"{inputpath2}/{j}"
    print(j)
    dirs = os.listdir(inputpath)
    #comment out till here
    for l in liste:
                i=f"{l[0]}.mp4"
                if i in dirs:
                    outfile = i.replace(".mp4", ".pv")
                    #checks if video was alread processed, if .pv file exist in video folder
                    if os.path.exists(outfile) == True:
                        print(f"{i} already processed")
                        #continues with next iteration
                        continue
                    else:
                    print(i)
                    individual=l[1]
                    #runs tgrabs and then trex
                    #outputpath of tgrabs has to be inputpath of trex
                    subprocess.check_call([tgrabs, "-i", i, "-s", f"{outputpath}/tgrabs_parameters.settings", "-output_dir", inputpath])
                    subprocess.check_call([trex, "-i", f"{inputpath}/{outfile}", "-s",  f"{outputpath}/trex_parameters.settings", "-output_dir", outputpath, 
                                           "-track_max_individuals", str(individual)])
                    print(f"finish {i}")
